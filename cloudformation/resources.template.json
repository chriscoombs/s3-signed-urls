{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "s3-signed-urls",
    "Resources": {
        "Bucket": {
            "Type": "AWS::S3::Bucket"
        },
        "Function": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "Handler": "index.handler",
                "Runtime": "nodejs6.10",
                "CodeUri": "s3://s3-signed-urls-asar/function.zip",
                "Policies": [
                    "AWSLambdaExecute",
                    {
                        "Version": "2012-10-17",
                        "Statement": {
                            "Effect": "Allow",
                            "Action": [
                                "s3:getSignedUrl"
                            ],
                            "Resource": {
                                "Fn::Sub": "${Bucket.Arn}"
                            }
                        }
                    }
                ],
                "Environment": {
                    "Variables": {
                        "bucket": {
                            "Ref": "Bucket"
                        }
                    }
                }
            }
        },
        "Permission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:invokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "Function",
                        "Arn"
                    ]
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*"
                }
            }
        },
        "RestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Body": {
                    "swagger": "2.0",
                    "info": {
                        "version": "1.0.0",
                        "title": "s3-signed-urls"
                    },
                    "basePath": "/prod",
                    "schemes": [
                        "https"
                    ],
                    "paths": {
                        "/{proxy+}": {
                            "x-amazon-apigateway-any-method": {
                                "responses": {},
                                "x-amazon-apigateway-integration": {
                                    "uri": {
                                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function.Arn}/invocations"
                                    },
                                    "passthroughBehavior": "when_no_match",
                                    "httpMethod": "POST",
                                    "type": "aws_proxy"
                                }
                            }
                        }
                    },
                    "definitions": {
                        "Empty": {
                            "type": "object",
                            "title": "Empty Schema"
                        }
                    }
                }
            }
        },
        "Deployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                }
            }
        },
        "Stage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "DeploymentId": {
                    "Ref": "Deployment"
                },
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "StageName": "prod"
            }
        }
    }
}